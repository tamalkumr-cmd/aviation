<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Live Flight Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        html,
        body {
            margin: 0;
            height: 100%;
            background: #05080d;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            color: #e5e7eb;
        }
        
        #topbar {
            height: 56px;
            background: linear-gradient(90deg, #020617, #0f172a);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            border-bottom: 1px solid #1f2933;
        }
        
        #topbar h1 {
            font-size: 16px;
            color: #38bdf8;
        }
        
        #controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        #controls button,
        #controls input {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid #38bdf8;
            background: #020617;
            color: #38bdf8;
            font-weight: 600;
            cursor: pointer;
        }
        
        #container {
            display: flex;
            height: calc(100% - 56px);
        }
        
        #sidebar {
            width: 260px;
            background: #020617;
            border-right: 1px solid #1f2933;
            display: flex;
            flex-direction: column;
        }
        
        #sidebar input {
            margin: 10px;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #1f2933;
            background: #020617;
            color: #e5e7eb;
        }
        
        #flightList {
            flex: 1;
            overflow-y: auto;
        }
        
        .flightItem {
            padding: 10px;
            border-bottom: 1px solid #1f2933;
            cursor: pointer;
        }
        
        .flightItem:hover {
            background: #0f172a;
        }
        
        .flightItem.active {
            background: #0b2540;
            color: #38bdf8;
        }
        
        #map {
            flex: 1;
        }
        
        #infoPanel {
            width: 300px;
            background: #020617;
            border-left: 1px solid #1f2933;
            padding: 16px;
            box-sizing: border-box;
        }
        
        #infoPanel h2 {
            font-size: 14px;
            color: #38bdf8;
            margin-bottom: 12px;
        }
        
        .leaflet-tile {
            filter: brightness(0.6) contrast(1.2) saturate(0.8);
        }
        
        .plane-icon {
            font-size: 18px;
            transform-origin: center center;
            filter: drop-shadow(0 0 6px #facc15);
        }
        
        .plane-selected {
            filter: drop-shadow(0 0 12px #38bdf8);
        }
        
        .airport-circle {
            stroke: #38bdf8;
            fill: #38bdf8;
            fill-opacity: 0.15;
        }
    </style>
</head>

<body>

    <div id="topbar">
        <h1>✈️ Live Flight Map</h1>
        <div id="controls">
            <button id="toggleAnim">⏸ Pause</button>
            <label>Speed</label>
            <input type="range" id="speedSlider" min="0.25" max="4" step="0.25" value="1">
            <button onclick="window.location.href='/dashboard'">Back</button>
        </div>
    </div>

    <div id="container">
        <div id="sidebar">
            <input type="text" id="searchBox" placeholder="Search flight...">
            <div id="flightList"></div>
        </div>

        <div id="map"></div>

        <div id="infoPanel">
            <h2>Flight Details</h2>
            <div id="infoContent">Click a plane or a flight from the list.</div>
            <hr>
            <div id="stats"></div>
        </div>
    </div>

    <script>
        const map = L.map("map", {
            zoomControl: true,
            attributionControl: false
        }).setView([22.5, 80.0], 5);

        L.tileLayer("https://tiles.stadiamaps.com/tiles/alidade_smooth_dark/{z}/{x}/{y}{r}.png", {
            maxZoom: 19
        }).addTo(map);

        const cityCoords = {
            "Delhi": [28.6139, 77.2090],
            "Mumbai": [19.0760, 72.8777],
            "Chennai": [13.0827, 80.2707],
            "Bangalore": [12.9716, 77.5946],
            "Hyderabad": [17.3850, 78.4867],
            "Kolkata": [22.5726, 88.3639],
            "Durgapur": [23.5204, 87.3119],
            "Pune": [18.5204, 73.8567],
            "Ahmedabad": [23.0225, 72.5714],
            "Kochi": [9.9312, 76.2673],
            "Trivandrum": [8.5241, 76.9366],
            "Jaipur": [26.9124, 75.7873],
            "Guwahati": [26.1445, 91.7362]
        };

        let layers = [];
        let flightsState = [];
        let selectedFlightId = null;
        let isPaused = false;
        let speedMultiplier = 1;

        const flightListEl = document.getElementById("flightList");
        const searchBox = document.getElementById("searchBox");

        function clearMap() {
            layers.forEach(l => map.removeLayer(l));
            layers = [];
        }

        function computeBearing(src, dst) {
            const lat1 = src[0] * Math.PI / 180;
            const lat2 = dst[0] * Math.PI / 180;
            const dLon = (dst[1] - src[1]) * Math.PI / 180;
            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
            const brng = Math.atan2(y, x);
            return (brng * 180 / Math.PI + 360) % 360;
        }

        function distanceKm(a, b) {
            const R = 6371;
            const dLat = (b[0] - a[0]) * Math.PI / 180;
            const dLon = (b[1] - a[1]) * Math.PI / 180;
            const lat1 = a[0] * Math.PI / 180;
            const lat2 = b[0] * Math.PI / 180;
            const h = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
            return 2 * R * Math.asin(Math.sqrt(h));
        }

        function showFlightInfo(f, speed, altitude, progress, etaMin) {
            document.getElementById("infoContent").innerHTML = `
        <b>Flight:</b> ${f.flight_no || "N/A"}<br>
        <b>Route:</b> ${f.source} → ${f.destination}<br>
        <b>Status:</b> ${f.status || "Cruising"}<br>
        <b>Speed:</b> ${speed.toFixed(0)} km/h<br>
        <b>Altitude:</b> ${altitude.toFixed(0)} ft<br>
        <b>Progress:</b> ${(progress * 100).toFixed(0)}%<br>
        <b>ETA:</b> ${etaMin.toFixed(0)} min
    `;
        }

        function createPlaneMarker(pos, headingDeg, flight) {
            const icon = L.divIcon({
                className: "plane-icon",
                html: "✈️"
            });
            const marker = L.marker(pos, {
                icon
            }).addTo(map);

            setTimeout(() => {
                const el = marker.getElement();
                if (el) el.style.transform += ` rotate(${headingDeg}deg)`;
            }, 0);

            marker.bindTooltip(`${flight.flight_no} (${flight.source} → ${flight.destination})`);

            marker.on("click", () => {
                selectedFlightId = flight.flight_no;
                map.setView(pos, 6, {
                    animate: true
                });
                redraw();
            });

            layers.push(marker);
            return marker;
        }

        function animatePlane(marker, src, dst, baseDurationMs, flight) {
            let start = performance.now();
            const cruiseSpeed = 700 + Math.random() * 100;
            const cruiseAltitude = 30000 + Math.random() * 5000;

            function step(now) {
                if (isPaused) {
                    start += 16;
                    requestAnimationFrame(step);
                    return;
                }

                const durationMs = baseDurationMs / speedMultiplier;
                const t = Math.min((now - start) / durationMs, 1);

                const lat = src[0] + (dst[0] - src[0]) * t;
                const lng = src[1] + (dst[1] - src[1]) * t;

                marker.setLatLng([lat, lng]);

                const remainingMs = durationMs * (1 - t);
                const etaMin = remainingMs / 60000;

                if (selectedFlightId === flight.flight_no) {
                    showFlightInfo(flight, cruiseSpeed, cruiseAltitude, t, etaMin);
                    const el = marker.getElement();
                    if (el) el.classList.add("plane-selected");
                }

                if (t < 1) requestAnimationFrame(step);
            }

            requestAnimationFrame(step);
        }

        function buildFlightList() {
            flightListEl.innerHTML = "";
            const query = searchBox.value.toLowerCase();

            flightsState.forEach(f => {
                if (query && !(f.flight_no || "").toLowerCase().includes(query)) return;

                const div = document.createElement("div");
                div.className = "flightItem" + (selectedFlightId === f.flight_no ? " active" : "");
                div.textContent = `${f.flight_no || "N/A"}: ${f.source} → ${f.destination}`;
                div.onclick = () => {
                    selectedFlightId = f.flight_no;
                    redraw();
                };
                flightListEl.appendChild(div);
            });
        }

        function redraw() {
            clearMap();
            buildFlightList();

            let totalDist = 0;

            flightsState.forEach(f => {
                const src = cityCoords[(f.source || "").trim()];
                const dst = cityCoords[(f.destination || "").trim()];
                if (!src || !dst) return;

                const isSelected = selectedFlightId === f.flight_no;

                const route = L.polyline([src, dst], {
                    color: isSelected ? "#38bdf8" : "#facc15",
                    weight: isSelected ? 4 : 2.5,
                    dashArray: "6 10",
                    opacity: 0.9
                }).addTo(map);
                layers.push(route);

                L.circle(src, {
                    radius: 40000,
                    className: "airport-circle",
                    weight: 1
                }).addTo(map);
                L.circle(dst, {
                    radius: 40000,
                    className: "airport-circle",
                    weight: 1
                }).addTo(map);

                const bearing = computeBearing(src, dst);
                const plane = createPlaneMarker(src, bearing, f);

                const dist = distanceKm(src, dst);
                totalDist += dist;

                const hours = dist / 750;
                const durationMs = Math.max(hours * 60 * 60 * 1000, 10000);

                animatePlane(plane, src, dst, durationMs, f);
            });

            document.getElementById("stats").innerHTML = `
        <b>Total Flights:</b> ${flightsState.length}<br>
        <b>Avg Distance:</b> ${(totalDist / Math.max(1, flightsState.length)).toFixed(0)} km
    `;
        }

        async function loadFlights() {
            const res = await fetch("/api/flights");
            flightsState = await res.json();
            redraw();
        }

        document.getElementById("toggleAnim").onclick = () => {
            isPaused = !isPaused;
            document.getElementById("toggleAnim").textContent = isPaused ? "▶ Play" : "⏸ Pause";
        };

        document.getElementById("speedSlider").oninput = (e) => {
            speedMultiplier = parseFloat(e.target.value);
        };

        searchBox.oninput = buildFlightList;

        loadFlights();
    </script>

</body>

</html>