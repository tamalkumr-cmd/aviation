<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Flight Operations Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            background: #0b0f14;
            color: #e5e7eb;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        }
        
        #topbar {
            height: 56px;
            background: linear-gradient(90deg, #0b0f14, #0f172a);
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid #1f2933;
            font-weight: 600;
            letter-spacing: 0.5px;
            color: #38bdf8;
        }
        
        #map {
            height: calc(100% - 56px);
            width: 100%;
        }
        
        .info-panel {
            position: absolute;
            top: 70px;
            right: 16px;
            width: 280px;
            background: rgba(10, 15, 25, 0.9);
            border: 1px solid #1f2933;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.15);
            z-index: 1000;
        }
        
        .info-panel h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #38bdf8;
            border-bottom: 1px solid #1f2933;
            padding-bottom: 6px;
        }
        
        .flight-item {
            font-size: 13px;
            margin-bottom: 12px;
            color: #cbd5e1;
        }
        
        .flight-item span {
            color: #38bdf8;
            font-weight: 600;
        }
        
        .plane-icon {
            font-size: 22px;
            filter: drop-shadow(0 0 6px #38bdf8);
            transform-origin: center;
        }
    </style>
</head>

<body>
    <div id="topbar">✈️ Flight Operations Map | India Airspace</div>

    <div id="map"></div>

    <div class="info-panel">
        <h3>Active Flights</h3>
        <div id="flightList">Loading...</div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const map = L.map("map").setView([22.5, 80], 5);

        // Dark tile layer
        L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
            attribution: "&copy; OpenStreetMap & CARTO",
            subdomains: "abcd",
            maxZoom: 19
        }).addTo(map);

        // City coordinates
        const cityCoords = {
            "Chennai": [13.0827, 80.2707],
            "Durgapur": [23.5204, 87.3119],
            "Kolkata": [22.5726, 88.3639],
            "Delhi": [28.6139, 77.2090],
            "Mumbai": [19.0760, 72.8777],
            "Bangalore": [12.9716, 77.5946],
            "Hyderabad": [17.3850, 78.4867]
        };

        let markers = [];
        let polylines = [];

        function clearMap() {
            markers.forEach(m => map.removeLayer(m));
            polylines.forEach(p => map.removeLayer(p));
            markers = [];
            polylines = [];
        }

        function getBearing(start, end) {
            const lat1 = start[0] * Math.PI / 180;
            const lat2 = end[0] * Math.PI / 180;
            const dLon = (end[1] - start[1]) * Math.PI / 180;

            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) -
                Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);

            const brng = Math.atan2(y, x);
            return (brng * 180 / Math.PI + 360) % 360;
        }

        async function loadFlights() {
            const res = await fetch("/api/flights");
            const flights = await res.json();

            clearMap();

            const list = document.getElementById("flightList");
            list.innerHTML = "";

            flights.forEach(f => {
                const src = cityCoords[f.source];
                const dst = cityCoords[f.destination];
                if (!src || !dst) return;

                // Draw route
                const line = L.polyline([src, dst], {
                    color: "#38bdf8",
                    weight: 2,
                    dashArray: "6,6",
                    opacity: 0.8
                }).addTo(map);
                polylines.push(line);

                // Plane icon
                const planeIcon = L.divIcon({
                    className: "plane-icon",
                    html: "✈️",
                    iconSize: [24, 24]
                });

                const marker = L.marker(src, {
                    icon: planeIcon
                }).addTo(map);
                markers.push(marker);

                // Rotate plane
                const angle = getBearing(src, dst);
                setTimeout(() => {
                    if (marker.getElement()) {
                        marker.getElement().style.transform = `rotate(${angle}deg)`;
                    }
                }, 50);

                animateMarker(marker, src, dst);

                // HUD item
                const div = document.createElement("div");
                div.className = "flight-item";

                const fuelPct = Math.min(100, Math.max(0, f.fuel || 0));
                const statusColor = f.status === "Delayed" ? "#f87171" :
                    f.status === "Boarding" ? "#facc15" :
                    "#34d399";

                div.innerHTML = `
          <div><span>${f.flight_no}</span> ${f.source} → ${f.destination}</div>
          <div style="font-size:12px;color:${statusColor}">Status: ${f.status}</div>
          <div style="background:#1f2933;border-radius:6px;overflow:hidden;margin-top:4px;">
            <div style="height:6px;width:${fuelPct}%;background:#38bdf8;"></div>
          </div>
        `;

                list.appendChild(div);
            });
        }

        function animateMarker(marker, start, end) {
            let t = 0;

            function step() {
                t += 0.0015;
                if (t > 1) t = 0;

                const lat = start[0] + (end[0] - start[0]) * t;
                const lng = start[1] + (end[1] - start[1]) * t;

                marker.setLatLng([lat, lng]);
                requestAnimationFrame(step);
            }

            step();
        }

        loadFlights();
        setInterval(loadFlights, 5000);
    </script>
</body>

</html>